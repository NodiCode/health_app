const express = require('express');
const cors = require('cors');
const axios = require('axios');
const dotenv = require('dotenv');

// Загрузка переменных окружения
dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;
const GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'AIzaSyAHhpJldughwEcIY5w0evRgRIz-unZ7-wE';

// Middleware
app.use(cors());
app.use(express.json());

// Корневой маршрут
app.get('/', (req, res) => {
  res.send('Gemini API Proxy Server работает!');
});

// Получение списка моделей
app.get('/api/models', async (req, res) => {
  try {
    const response = await axios.get(
      `https://generativelanguage.googleapis.com/v1/models?key=${GEMINI_API_KEY}`
    );
    res.json(response.data);
  } catch (error) {
    console.error('Ошибка при получении моделей:', error.message);
    res.status(500).json({ error: 'Не удалось получить список моделей' });
  }
});

// Прокси для Gemini API
app.post('/api/gemini', async (req, res) => {
  try {
    const requestData = req.body;
    console.log('Запрос к прокси-серверу:', JSON.stringify(requestData, null, 2));

    // Используем Gemini 1.5 Flash - доступную модель из списка
    const geminiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    console.log('Отправка запроса к Gemini API:', geminiUrl);
    
    const geminiResponse = await axios.post(
      geminiUrl,
      requestData,
      {
        headers: { 'Content-Type': 'application/json' }
      }
    );

    console.log('Успешный ответ от Gemini API');
    res.json(geminiResponse.data);
  } catch (error) {
    console.error('Ошибка при запросе к Gemini API:', error.message);
    
    // Если запрос не удался и есть ответ с ошибкой
    if (error.response) {
      console.error('Ответ с ошибкой:', JSON.stringify(error.response.data, null, 2));
      console.error('Статус ошибки:', error.response.status);
      
      // Если API-ключ истек или недействителен, создаем мок-ответ
      if (error.response.status === 400 || error.response.status === 401 || error.response.status === 403) {
        console.log('Использование мок-ответа из-за проблем с API');
        
        // Получаем симптомы из запроса
        const requestText = req.body.contents[0].parts[0].text || '';
        const symptomsMatch = requestText.match(/симптомы:\s*([^\n]+)/i);
        const symptoms = symptomsMatch ? symptomsMatch[1].trim() : 'неизвестные симптомы';
        
        console.log('Распознанные симптомы:', symptoms);
        
        // Генерируем мок-ответ в зависимости от симптомов
        let responseText = '';
        
        if (symptoms.toLowerCase().includes('глаз')) {
          responseText = "Анализ симптомов: зуд в глазах\n\n1. Возможные диагнозы\n- Аллергический конъюнктивит\n- Синдром сухого глаза\n- Блефарит\n- Инфекционный конъюнктивит\n\n2. Описание\n- Аллергический конъюнктивит - воспаление глаз в ответ на аллергены, характеризуется зудом, покраснением и слезотечением\n- Синдром сухого глаза - недостаточное увлажнение поверхности глаза, что вызывает дискомфорт, зуд и раздражение\n- Блефарит - воспаление век, часто сопровождающееся зудом, покраснением и чешуйками на ресницах\n- Инфекционный конъюнктивит - бактериальная или вирусная инфекция, вызывающая воспаление конъюнктивы\n\n3. Рекомендации\n- Избегайте трения глаз, это может усилить раздражение\n- Используйте холодные компрессы для облегчения зуда\n- При аллергии может помочь прием антигистаминных препаратов (после консультации с врачом)\n- Используйте искусственные слезы для увлажнения глаз\n- Соблюдайте гигиену глаз\n\n4. Когда следует немедленно обратиться к врачу\nНемедленно обратитесь к офтальмологу, если:\n- Зуд сопровождается сильной болью\n- Появилось нарушение зрения\n- Присутствует гнойное отделяемое\n- Есть светобоязнь (болезненная реакция на свет)\n- Симптомы не улучшаются в течение 2-3 дней или ухудшаются\n\n⚠️ ВАЖНО: Этот анализ носит информационный характер и не заменяет профессиональную медицинскую консультацию. Для точной диагностики и назначения лечения обратитесь к офтальмологу.";
        } else if (symptoms.toLowerCase().includes('голов')) {
          responseText = "Анализ симптомов: головная боль\n\n1. Возможные диагнозы\n- Мигрень\n- Головная боль напряжения\n- Кластерная головная боль\n- Синусит\n- Гипертония\n\n2. Описание\n- Мигрень - интенсивная пульсирующая боль, часто с одной стороны головы, может сопровождаться тошнотой и чувствительностью к свету и звуку\n- Головная боль напряжения - тупая, сдавливающая боль, обычно с обеих сторон головы\n- Кластерная головная боль - очень сильная боль вокруг одного глаза или виска\n- Синусит - воспаление придаточных пазух носа, вызывающее боль в области лба, скул или переносицы\n- Гипертония - повышенное артериальное давление, которое может вызывать головную боль\n\n3. Рекомендации\n- Отдохните в тихом, темном помещении\n- Приложите холодный или теплый компресс к голове\n- Выпейте воды, так как обезвоживание может вызывать головную боль\n- При необходимости примите безрецептурные обезболивающие (после консультации с врачом)\n- Практикуйте методы релаксации, такие как глубокое дыхание или медитация\n\n4. Когда следует немедленно обратиться к врачу\nНемедленно обратитесь к врачу, если головная боль:\n- Возникла внезапно и очень сильная (\"громоподобная\")\n- Сопровождается лихорадкой, ригидностью шеи, сыпью, спутанностью сознания или судорогами\n- Возникла после травмы головы\n- Сопровождается проблемами с речью, зрением, движением или потерей равновесия\n- Значительно отличается от ваших обычных головных болей\n\n⚠️ ВАЖНО: Это предварительный анализ. Для точной диагностики и лечения обратитесь к врачу, особенно если головные боли регулярно повторяются или усиливаются.";
        } else {
          responseText = `Анализ симптомов: ${symptoms}\n\n1. Возможные диагнозы\n- Вирусная инфекция\n- Аллергическая реакция\n- Переутомление\n- Стресс\n\n2. Описание\n- Вирусная инфекция - заболевание, вызванное вирусами, часто сопровождается общими симптомами\n- Аллергическая реакция - иммунный ответ организма на аллерген\n- Переутомление - состояние, вызванное чрезмерной физической или умственной нагрузкой\n- Стресс - реакция организма на психологическое напряжение\n\n3. Рекомендации\n- Обеспечьте достаточный отдых\n- Пейте больше жидкости\n- Избегайте возможных аллергенов\n- Практикуйте техники релаксации\n- Следите за сбалансированным питанием\n\n4. Когда следует немедленно обратиться к врачу\nНемедленно обратитесь к врачу, если:\n- Симптомы быстро ухудшаются\n- Появилась высокая температура\n- Есть затруднение дыхания\n- Появились сильные боли\n- Симптомы не улучшаются через несколько дней\n\n⚠️ ВАЖНО: Этот анализ носит информационный характер и не заменяет профессиональную медицинскую консультацию. Для точной диагностики и назначения лечения обратитесь к врачу.`;
        }
        
        // Возвращаем мок-ответ в формате Gemini API
        return res.json({
          candidates: [
            {
              content: {
                parts: [
                  { text: responseText }
                ]
              }
            }
          ]
        });
      }
      
      // Если другая ошибка, возвращаем информацию об ошибке
      res.status(error.response.status).json({
        error: 'Ошибка от API Gemini',
        details: error.response.data,
        status: error.response.status
      });
    } else {
      // Если ошибка связи или другая
      res.status(500).json({
        error: 'Ошибка запроса',
        details: error.message
      });
    }
  }
});

// Запуск сервера
app.listen(PORT, () => {
  console.log(`Сервер запущен на порту ${PORT}`);
  console.log(`Перейдите по адресу http://localhost:${PORT}`);
});